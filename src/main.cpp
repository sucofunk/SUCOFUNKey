/* ----------------------------------------------------------------------------------------------

    SUCOFUNKey

    This project is the firmware - named SUCOFUNKey - for Beatmaker's Sketchbook from SUCOFUNK. 

    For more information, check out www.sucofunk.com

    To support the development of this firmware, please donate to the project and buy hardware
    from sucofunk.com.

    Copyright 2021-2022 by Marc Berendes (marc @ sucofunk.com)
    
   ----------------------------------------------------------------------------------------------

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.    

   ---------------------------------------------------------------------------------------------- */

#include <Arduino.h>

#include "helper/AudioResources.h"
#include "hardware/Sucofunkey.h"
#include "helper/FSIO.h"
#include "helper/SampleFSIO.h"
#include "gui/Screen.h"
#include "gui/screens/StartupScreen.h"
#include "context/home/Home.h" 
#include "context/sampler/Sampler.h" 
#include "context/sequencer/Sequencer.h"
#include "context/synth/Synth.h"
#include "context/live/Live.h"
#include "context/settings/Settings.h"
#include "context/recorder/Recorder.h"
#include "context/check/Check.h"
#include <Audio.h>
#include <MIDI.h>

#include <Adafruit_ST7789.h>

// PINs on the Teensy 4.1 to receive Interrupts from the 5 MCP23017 chips used as port expanders to receive updated from the 36 Buttons and 4 rotary encoders
// The MCP23017s control the 32 LEDs in the SUCOFUNKey, too

int PIN_SUCOKEY_INT_1 = 28; 
int PIN_SUCOKEY_INT_2 = 29; 
int PIN_SUCOKEY_INT_3 = 30; 
int PIN_SUCOKEY_INT_4 = 31;
int PIN_SUCOKEY_INT_5 = 32; 

// PINs for the display 
int PIN_SCREEN_SCK = 27;
int PIN_SCREEN_MOSI = 26; // labeled as DIN on the Waveshare display
int PIN_SCREEN_CS = 38;
int PIN_SCREEN_DC = 39;
int PIN_SCREEN_RST = 37;
int PIN_SCREEN_BL = 36;

// Analog PIN where volume potentiometer is connected to
int PIN_VOLUME = 22;
float volumeValue = 0;
float volumeTempValue = 0;

// ToDo: make configurable
byte MIDI_channel_Synth = 10;
byte MIDI_channel_Live = 1;

MIDI_CREATE_INSTANCE(HardwareSerial, Serial1, MIDI);

// Function definitions
void handleKeyboardEventQueue(void);
void changeContext(byte context);

enum AppContext {
  HOME = 0, SAMPLER = 1, SEQUENCER = 2, SYNTH = 3, LIVE = 4, SETTINGS = 5, STARTUP = 6, RECORDER = 7, SYSTEMCHECK = 8
};

AppContext currentAppContext; // stores the current active "module" context (HOME|SAMPLER|...)
AppContext lastAppContext;

char songsBasePath[8] = "/SONGS/";
char activeSongName[9];
char activeSongPath[21];

// Sample Memory initialization - one psram chip with 8mb added to teensy board
//EXTMEM unsigned int extmemArray[2097152]; // 8mb
EXTMEM unsigned int extmemArray[4194304]; //  16mb

// Interval Timer for playback pattern, metronome, etc..
IntervalTimer globalTickTimer;
volatile boolean ticked = false;
long globalTickInterval = 1000000; // intervall in microseconds -> starts at 1s
long globalTickIntervalNew;
void globalTick();

// Interval Timer for recording
IntervalTimer globalTickTimerRec;
volatile boolean tickedRec = false;
long globalTickIntervalRec = 1000000; // intervall in microseconds -> starts at 1s
long globalTickIntervalRecNew;
void globalTickRec();

AudioResources audioResources;

// Hardware SPI for LCD Screen
Adafruit_ST7789 tft(&SPI1, PIN_SCREEN_CS, PIN_SCREEN_DC, PIN_SCREEN_RST);

// Initializing the "keyboard"
Sucofunkey keyboard(PIN_SUCOKEY_INT_1, PIN_SUCOKEY_INT_2, PIN_SUCOKEY_INT_3, PIN_SUCOKEY_INT_4, PIN_SUCOKEY_INT_5);

// Initializing GUI System
Screen screen(&tft, PIN_SCREEN_BL, 110);

FSIO fsio;
// store the filenames from /SAMPLES from the SD card in this array for fast access
DMAMEM FSIO::LibrarySample librarySamples[500];

SampleFSIO sfsio(extmemArray, sizeof(extmemArray), &screen);

Home  homeContext(&keyboard, &screen, activeSongPath, activeSongName);
Sampler samplerContext(&keyboard, &screen, &fsio, &sfsio, &audioResources);
Recorder recorderContext(&keyboard, &screen, &fsio, &sfsio, &audioResources);
Sequencer sequencerContext(&keyboard, &screen, &fsio, &sfsio, extmemArray, &audioResources);

Synth synthContext(&keyboard, &screen, &fsio, &sfsio, extmemArray, &audioResources);
Live liveContext(&keyboard, &screen, &fsio, &sfsio, extmemArray, &audioResources);

Settings settingsContext(&keyboard, &screen);
StartupScreen startupContext(&keyboard, &screen, &fsio, activeSongName);

Check systemCheckContext(&keyboard, &screen);


// --- START Audio Connections
// unfortunately this is not initializable in the AudioResources class?!?

AudioConnection          patchCord1(audioResources.wavetable1, 0, audioResources.mixerWav1L, 0);
AudioConnection          patchCord2(audioResources.wavetable1, 0, audioResources.mixerWav1R, 0);
AudioConnection          patchCord3(audioResources.wavetable2, 0, audioResources.mixerWav1L, 1);
AudioConnection          patchCord4(audioResources.wavetable2, 0, audioResources.mixerWav1R, 1);
AudioConnection          patchCord5(audioResources.wavetable3, 0, audioResources.mixerWav1L, 2);
AudioConnection          patchCord6(audioResources.wavetable3, 0, audioResources.mixerWav1R, 2);
AudioConnection          patchCord15(audioResources.wavetable4, 0, audioResources.mixerWav1L, 3);
AudioConnection          patchCord16(audioResources.wavetable4, 0, audioResources.mixerWav1R, 3);
AudioConnection          patchCord21(audioResources.wavetable5, 0, audioResources.mixerWav2L, 0);
AudioConnection          patchCord22(audioResources.wavetable5, 0, audioResources.mixerWav2R, 0);
AudioConnection          patchCord7(audioResources.wavetable6, 0, audioResources.mixerWav2L, 1);
AudioConnection          patchCord8(audioResources.wavetable6, 0, audioResources.mixerWav2R, 1);
AudioConnection          patchCord9(audioResources.wavetable7, 0, audioResources.mixerWav2L, 2);
AudioConnection          patchCord10(audioResources.wavetable7, 0, audioResources.mixerWav2R, 2);
AudioConnection          patchCord11(audioResources.wavetable8, 0, audioResources.mixerWav2L, 3);
AudioConnection          patchCord12(audioResources.wavetable8, 0, audioResources.mixerWav2R, 3);

AudioConnection          patchCord17(audioResources.playMem1, 0, audioResources.mixerMem1L, 0);
AudioConnection          patchCord18(audioResources.playMem1, 0, audioResources.mixerMem1R, 0);
AudioConnection          patchCord23(audioResources.playMem2, 0, audioResources.mixerMem1L, 1);
AudioConnection          patchCord24(audioResources.playMem2, 0, audioResources.mixerMem1R, 1);
AudioConnection          patchCord25(audioResources.playMem3, 0, audioResources.mixerMem1L, 2);
AudioConnection          patchCord26(audioResources.playMem3, 0, audioResources.mixerMem1R, 2);
AudioConnection          patchCord27(audioResources.playMem4, 0, audioResources.mixerMem1L, 3);
AudioConnection          patchCord28(audioResources.playMem4, 0, audioResources.mixerMem1R, 3);
AudioConnection          patchCord29(audioResources.playMem5, 0, audioResources.mixerMem2L, 0);
AudioConnection          patchCord30(audioResources.playMem5, 0, audioResources.mixerMem2R, 0);
AudioConnection          patchCord31(audioResources.playMem6, 0, audioResources.mixerMem2L, 1);
AudioConnection          patchCord32(audioResources.playMem6, 0, audioResources.mixerMem2R, 1);
AudioConnection          patchCord13(audioResources.playMem7, 0, audioResources.mixerMem2L, 2);
AudioConnection          patchCord14(audioResources.playMem7, 0, audioResources.mixerMem2R, 2);
AudioConnection          patchCord19(audioResources.playMem8, 0, audioResources.mixerMem2L, 3);
AudioConnection          patchCord20(audioResources.playMem8, 0, audioResources.mixerMem2R, 3);

AudioConnection          patchCord37(audioResources.playSdRaw, 0, audioResources.mixerSDL, 0);
AudioConnection          patchCord38(audioResources.playSdRaw, 0, audioResources.mixerSDR, 0);

AudioConnection          patchCord39(audioResources.playMem, 0, audioResources.mixerSDL, 1);
AudioConnection          patchCord40(audioResources.playMem, 0, audioResources.mixerSDR, 1);


AudioConnection          patchCord43(audioResources.mixerSDL, 0, audioResources.mixerPreOutL, 2);
AudioConnection          patchCord44(audioResources.mixerSDR, 0, audioResources.mixerPreOutR, 2);

AudioConnection          patchCord41(audioResources.recordMixer, audioResources.queue1);
AudioConnection          patchCord42(audioResources.recordMixer, audioResources.peak1);



AudioConnection          patchCord33(audioResources.audioInput, 0, audioResources.recordMixer, 0);
AudioConnection          patchCord34(audioResources.audioInput, 0, audioResources.mixerOutL, 0);
AudioConnection          patchCord35(audioResources.audioInput, 1, audioResources.recordMixer, 1);
AudioConnection          patchCord36(audioResources.audioInput, 1, audioResources.mixerOutR, 0);


AudioConnection          patchCord47(audioResources.mixerMem1L, 0, audioResources.mixerMemL, 0);
AudioConnection          patchCord48(audioResources.mixerMem1R, 0, audioResources.mixerMemR, 0);
AudioConnection          patchCord45(audioResources.mixerMem2L, 0, audioResources.mixerMemL, 1);
AudioConnection          patchCord46(audioResources.mixerMem2R, 0, audioResources.mixerMemR, 1);
AudioConnection          patchCord89(audioResources.mixerMem3L, 0, audioResources.mixerMemL, 2);
AudioConnection          patchCord90(audioResources.mixerMem3R, 0, audioResources.mixerMemR, 2);
AudioConnection          patchCord91(audioResources.mixerMem3L, 0, audioResources.mixerMemL, 3);
AudioConnection          patchCord92(audioResources.mixerMem3R, 0, audioResources.mixerMemR, 3);

AudioConnection          patchCord51(audioResources.mixerWav1L, 0, audioResources.mixerWavL, 0);
AudioConnection          patchCord52(audioResources.mixerWav1R, 0, audioResources.mixerWavR, 0);
AudioConnection          patchCord49(audioResources.mixerWav2L, 0, audioResources.mixerWavL, 1);
AudioConnection          patchCord50(audioResources.mixerWav2R, 0, audioResources.mixerWavR, 1);

AudioConnection          patchCord53(audioResources.mixerMemL, 0, audioResources.mixerPreOutL, 0);
AudioConnection          patchCord54(audioResources.mixerMemR, 0, audioResources.mixerPreOutR, 0);

AudioConnection          patchCord55(audioResources.mixerWavL, 0, audioResources.mixerPreOutL, 1);
AudioConnection          patchCord56(audioResources.mixerWavR, 0, audioResources.mixerPreOutR, 1);

AudioConnection          patchCord57(audioResources.mixerPreOutL, 0, audioResources.recordMixer, 2);
AudioConnection          patchCord58(audioResources.mixerPreOutL, 0, audioResources.mixerOutL, 1);
AudioConnection          patchCord59(audioResources.mixerPreOutR, 0, audioResources.recordMixer, 3);
AudioConnection          patchCord60(audioResources.mixerPreOutR, 0, audioResources.mixerOutR, 1);

AudioConnection          patchCord61(audioResources.mixerOutL, 0, audioResources.audioOutput, 0);
AudioConnection          patchCord62(audioResources.mixerOutR, 0, audioResources.audioOutput, 1);

AudioConnection          patchCord68(audioResources.wavetableSynth1, 0, audioResources.mixerSynth1, 0);
AudioConnection          patchCord66(audioResources.wavetableSynth2, 0, audioResources.mixerSynth1, 1);
AudioConnection          patchCord67(audioResources.wavetableSynth3, 0, audioResources.mixerSynth1, 2);
AudioConnection          patchCord65(audioResources.wavetableSynth4, 0, audioResources.mixerSynth1, 3);
AudioConnection          patchCord63(audioResources.wavetableSynth5, 0, audioResources.mixerSynth2, 0);
AudioConnection          patchCord64(audioResources.wavetableSynth6, 0, audioResources.mixerSynth2, 1);

AudioConnection          patchCord71(audioResources.mixerSynth, 0, audioResources.mixerPreOutL, 3);
AudioConnection          patchCord72(audioResources.mixerSynth, 0, audioResources.mixerPreOutR, 3);

AudioConnection          patchCord69(audioResources.mixerSynth1, 0, audioResources.mixerSynth, 0);
AudioConnection          patchCord70(audioResources.mixerSynth2, 0, audioResources.mixerSynth, 1);

AudioConnection          patchCord73(audioResources.playMemLive1, 0, audioResources.mixerMem3L, 0);
AudioConnection          patchCord74(audioResources.playMemLive1, 0, audioResources.mixerMem3R, 0);
AudioConnection          patchCord75(audioResources.playMemLive2, 0, audioResources.mixerMem3L, 1);
AudioConnection          patchCord76(audioResources.playMemLive2, 0, audioResources.mixerMem3R, 1);
AudioConnection          patchCord77(audioResources.playMemLive3, 0, audioResources.mixerMem3L, 2);
AudioConnection          patchCord78(audioResources.playMemLive3, 0, audioResources.mixerMem3R, 2);
AudioConnection          patchCord79(audioResources.playMemLive4, 0, audioResources.mixerMem3L, 3);
AudioConnection          patchCord80(audioResources.playMemLive4, 0, audioResources.mixerMem3R, 3);
AudioConnection          patchCord81(audioResources.playMemLive5, 0, audioResources.mixerMem4L, 0);
AudioConnection          patchCord82(audioResources.playMemLive5, 0, audioResources.mixerMem4R, 0);
AudioConnection          patchCord83(audioResources.playMemLive6, 0, audioResources.mixerMem4L, 1);
AudioConnection          patchCord84(audioResources.playMemLive6, 0, audioResources.mixerMem4R, 1);
AudioConnection          patchCord85(audioResources.playMemLive7, 0, audioResources.mixerMem4L, 2);
AudioConnection          patchCord86(audioResources.playMemLive7, 0, audioResources.mixerMem4R, 2);
AudioConnection          patchCord87(audioResources.playMemLive8, 0, audioResources.mixerMem4L, 3);
AudioConnection          patchCord88(audioResources.playMemLive8, 0, audioResources.mixerMem4R, 3);

// next patchcord nr: 93

// --- END of AudioConnections

// Images converted at http://javl.github.io/image2cpp/

// --- SUCOFUNK Logo / 320x54px 
const unsigned char startup_logo[] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 
	0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x04, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 
	0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x03, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0c, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 
	0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x03, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 
	0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x06, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x08, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x7f, 
	0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x06, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x18, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0xc0, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x06, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x18, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01, 0x80, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x0c, 0x00, 0x00, 0x00, 
	0x00, 0x03, 0xff, 0xfc, 0x00, 0x03, 0xff, 0x00, 0x01, 0xff, 0x80, 0x00, 0x7f, 0xff, 0x80, 0x00, 
	0x00, 0x7f, 0xff, 0xc0, 0x00, 0xfe, 0x01, 0xff, 0x87, 0xff, 0x00, 0x03, 0xff, 0x80, 0xff, 0xc1, 
	0xff, 0xc0, 0x00, 0x30, 0x0c, 0x00, 0x3f, 0xff, 0x00, 0x1f, 0xff, 0xff, 0x80, 0x07, 0xff, 0x80, 
	0x03, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xe0, 0x00, 0x03, 0xff, 0xff, 0xf0, 0x01, 0xfe, 0x01, 0xff, 
	0x87, 0xff, 0x00, 0x03, 0xff, 0x80, 0xff, 0xcf, 0xff, 0xf8, 0x00, 0x30, 0x0c, 0x00, 0x7f, 0xfe, 
	0x00, 0x78, 0x00, 0x01, 0xc0, 0x06, 0x01, 0x00, 0x03, 0x00, 0xc0, 0x0f, 0x00, 0x00, 0x78, 0x00, 
	0x0f, 0x00, 0x00, 0x3c, 0x01, 0x80, 0x00, 0x01, 0x8c, 0x03, 0x00, 0x06, 0x01, 0x81, 0x80, 0xdc, 
	0x00, 0x1c, 0x00, 0x30, 0x0c, 0x00, 0xe0, 0x0c, 0x00, 0xe0, 0x00, 0x00, 0x70, 0x06, 0x03, 0x00, 
	0x03, 0x00, 0x80, 0x1c, 0x00, 0x00, 0x1c, 0x00, 0x1c, 0x00, 0x00, 0x0e, 0x01, 0x80, 0x00, 0x01, 
	0x8c, 0x03, 0x00, 0x06, 0x01, 0x81, 0x80, 0xf8, 0x00, 0x06, 0x00, 0x30, 0x08, 0x01, 0x80, 0x38, 
	0x01, 0x80, 0x00, 0x00, 0x38, 0x04, 0x03, 0x00, 0x02, 0x01, 0x80, 0x30, 0x00, 0x00, 0x06, 0x00, 
	0x30, 0x00, 0x00, 0x03, 0x01, 0x00, 0x00, 0x01, 0x8c, 0x03, 0x00, 0x06, 0x01, 0x81, 0x80, 0xe0, 
	0x00, 0x03, 0x00, 0x30, 0x18, 0x03, 0x00, 0x70, 0x03, 0x00, 0x00, 0x00, 0x18, 0x0c, 0x03, 0x00, 
	0x06, 0x01, 0x80, 0x60, 0x00, 0x00, 0x03, 0x00, 0x60, 0x00, 0x00, 0x01, 0x83, 0x00, 0x00, 0x01, 
	0x8c, 0x02, 0x00, 0x06, 0x01, 0x01, 0x80, 0xc0, 0x00, 0x01, 0x80, 0x20, 0x18, 0x0e, 0x00, 0xe0, 
	0x06, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x03, 0x00, 0x06, 0x01, 0x80, 0xc0, 0x00, 0x00, 0x03, 0x00, 
	0xc0, 0x00, 0x00, 0x00, 0xc3, 0x00, 0x00, 0x01, 0x08, 0x06, 0x00, 0x06, 0x03, 0x01, 0x80, 0x80, 
	0x00, 0x01, 0x80, 0x60, 0x18, 0x1c, 0x01, 0x80, 0x06, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x03, 0x00, 
	0x06, 0x01, 0x81, 0x80, 0x00, 0x00, 0x01, 0x81, 0x80, 0x00, 0x00, 0x00, 0xc3, 0x00, 0x00, 0x03, 
	0x08, 0x06, 0x00, 0x04, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x60, 0x18, 0x38, 0x03, 0x00, 
	0x0c, 0x00, 0xff, 0xe0, 0x04, 0x0c, 0x02, 0x00, 0x06, 0x01, 0x01, 0x80, 0x0f, 0xf8, 0x01, 0x81, 
	0x80, 0x0f, 0xf8, 0x00, 0x63, 0x00, 0x00, 0x03, 0x18, 0x06, 0x00, 0x0c, 0x03, 0x03, 0x00, 0x03, 
	0xf8, 0x00, 0xc0, 0x60, 0x18, 0x70, 0x06, 0x00, 0x0c, 0x03, 0xff, 0xf0, 0x04, 0x0c, 0x06, 0x00, 
	0x06, 0x03, 0x03, 0x00, 0x7f, 0xfc, 0x00, 0x83, 0x00, 0x3f, 0xfe, 0x00, 0x63, 0xfc, 0x03, 0xff, 
	0x18, 0x06, 0x00, 0x0c, 0x03, 0x03, 0x00, 0x0f, 0xfe, 0x00, 0xc0, 0x60, 0x10, 0xc0, 0x1c, 0x00, 
	0x0c, 0x03, 0x00, 0x18, 0x04, 0x08, 0x06, 0x00, 0x04, 0x03, 0x03, 0x00, 0xe0, 0x06, 0x00, 0x83, 
	0x00, 0xe0, 0x03, 0x00, 0x63, 0xfc, 0x07, 0xfe, 0x18, 0x06, 0x00, 0x0c, 0x03, 0x03, 0x00, 0x3c, 
	0x03, 0x00, 0x40, 0x60, 0x31, 0x80, 0x38, 0x00, 0x08, 0x06, 0x00, 0x1f, 0xfc, 0x18, 0x06, 0x00, 
	0x0c, 0x03, 0x06, 0x00, 0xc0, 0x03, 0x00, 0xc6, 0x00, 0xc0, 0x01, 0x80, 0x60, 0x08, 0x06, 0x00, 
	0x18, 0x04, 0x00, 0x0c, 0x02, 0x03, 0x00, 0x70, 0x03, 0x00, 0x40, 0x40, 0x33, 0x00, 0x70, 0x00, 
	0x18, 0x06, 0x00, 0x1f, 0xfc, 0x18, 0x06, 0x00, 0x0c, 0x03, 0x06, 0x01, 0x80, 0x03, 0x00, 0xc6, 
	0x01, 0x80, 0x01, 0x80, 0x60, 0x18, 0x06, 0x00, 0x10, 0x0c, 0x00, 0x0c, 0x06, 0x02, 0x00, 0x60, 
	0x01, 0x00, 0xc0, 0xc0, 0x3e, 0x00, 0xc0, 0x00, 0x18, 0x07, 0x80, 0x00, 0x00, 0x18, 0x06, 0x00, 
	0x0c, 0x03, 0x06, 0x01, 0x00, 0x03, 0x00, 0x86, 0x03, 0x00, 0x01, 0x80, 0x60, 0x18, 0x06, 0x00, 
	0x30, 0x0c, 0x00, 0x08, 0x06, 0x06, 0x00, 0xc0, 0x01, 0x00, 0xc0, 0xc0, 0x3c, 0x01, 0x80, 0x00, 
	0x1f, 0xff, 0xfc, 0x00, 0x00, 0x1f, 0xfc, 0x00, 0x0f, 0xfe, 0x07, 0xff, 0x00, 0x03, 0xff, 0x8f, 
	0xff, 0x00, 0x01, 0xff, 0xe0, 0x1f, 0xfe, 0x00, 0x3f, 0xfc, 0x00, 0x1f, 0xfe, 0x07, 0xff, 0x80, 
	0x01, 0xff, 0xc0, 0xff, 0xff, 0xff, 0x00, 0x00, 0x1f, 0xff, 0x7f, 0xe0, 0x00, 0x1f, 0xfc, 0x00, 
	0x0f, 0xfe, 0x0f, 0xff, 0x00, 0x00, 0x00, 0x0f, 0xff, 0x00, 0x01, 0xff, 0xe0, 0x1f, 0xfc, 0x00, 
	0x3f, 0xec, 0x00, 0x1f, 0xfe, 0x07, 0xfd, 0x80, 0x03, 0xff, 0xc0, 0xff, 0xff, 0xfe, 0x00, 0x00, 
	0x08, 0x00, 0x01, 0xfe, 0x00, 0x30, 0x0c, 0x00, 0x08, 0x06, 0x0c, 0x03, 0x00, 0x00, 0x00, 0x0c, 
	0x03, 0x00, 0x01, 0x80, 0x60, 0x10, 0x0c, 0x00, 0x30, 0x08, 0x00, 0x18, 0x06, 0x06, 0x01, 0x00, 
	0x03, 0x00, 0xc0, 0x80, 0x00, 0x1c, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x0f, 0x80, 0x30, 0x0c, 0x00, 
	0x18, 0x06, 0x0c, 0x02, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x01, 0x80, 0x60, 0x30, 0x0c, 0x00, 
	0x30, 0x18, 0x00, 0x18, 0x04, 0x06, 0x03, 0x00, 0x03, 0x00, 0xc0, 0x80, 0x00, 0x0c, 0x00, 0x00, 
	0x07, 0xff, 0xff, 0xff, 0xc0, 0x3f, 0xfc, 0x00, 0x1f, 0xfe, 0x0f, 0xfe, 0x00, 0x00, 0x00, 0x0f, 
	0xfe, 0x00, 0x01, 0xff, 0xc0, 0x3f, 0xfc, 0x00, 0x3f, 0xf8, 0x00, 0x1f, 0xfc, 0x07, 0xff, 0x00, 
	0x03, 0xff, 0x81, 0xff, 0xff, 0xfc, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xe0, 0x3f, 0xe8, 0x00, 
	0x1f, 0xf6, 0x0f, 0xfe, 0x00, 0x00, 0x00, 0x0f, 0xfe, 0x00, 0x01, 0xff, 0xc0, 0x3f, 0xfc, 0x00, 
	0x7f, 0xf8, 0x00, 0x1f, 0xfc, 0x0f, 0xff, 0x00, 0x03, 0xff, 0x81, 0xff, 0xff, 0xfe, 0x00, 0x00, 
	0x01, 0xe0, 0x00, 0x00, 0x30, 0x30, 0x18, 0x00, 0x18, 0x04, 0x18, 0x06, 0x00, 0x00, 0x00, 0x18, 
	0x06, 0x00, 0x01, 0x00, 0xc0, 0x30, 0x08, 0x00, 0x60, 0x18, 0x00, 0x30, 0x0c, 0x0c, 0x03, 0x00, 
	0x06, 0x01, 0x81, 0x80, 0x00, 0x03, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x00, 0x18, 0x20, 0x18, 0x00, 
	0x10, 0x0c, 0x18, 0x06, 0x00, 0x00, 0x00, 0x18, 0x06, 0x00, 0x03, 0x00, 0xc0, 0x30, 0x18, 0x00, 
	0x60, 0x18, 0x00, 0x30, 0x0c, 0x0c, 0x03, 0x00, 0x06, 0x01, 0x81, 0x80, 0x00, 0x03, 0x00, 0x00, 
	0x00, 0x0f, 0xfe, 0xff, 0xf8, 0x7f, 0xf8, 0x00, 0x3f, 0xfc, 0x1f, 0xf6, 0x00, 0x07, 0xff, 0x1f, 
	0xf6, 0x00, 0x03, 0xff, 0xc0, 0x3f, 0xf8, 0x00, 0x7f, 0xd0, 0x00, 0x3f, 0xe8, 0x0f, 0xfe, 0x00, 
	0x07, 0xfd, 0x81, 0xff, 0xef, 0xfd, 0x80, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xf8, 0x7f, 0xf8, 0x00, 
	0x3f, 0xfc, 0x1f, 0xfc, 0x00, 0x07, 0xff, 0x1f, 0xfc, 0x00, 0x03, 0xff, 0x80, 0x7f, 0xf8, 0x00, 
	0x7f, 0xf0, 0x00, 0x7f, 0xf8, 0x0f, 0xfe, 0x00, 0x07, 0xff, 0x03, 0xff, 0xff, 0xff, 0x80, 0x00, 
	0x7f, 0xf0, 0x01, 0xe0, 0x18, 0x60, 0x18, 0x00, 0x60, 0x0c, 0x18, 0x04, 0x00, 0x0c, 0x03, 0x18, 
	0x04, 0x00, 0x02, 0x01, 0x80, 0x60, 0x18, 0x00, 0x40, 0x30, 0x00, 0x60, 0x18, 0x08, 0x06, 0x00, 
	0x06, 0x03, 0x03, 0x00, 0x36, 0x00, 0xc0, 0x00, 0x7f, 0xf0, 0x00, 0x60, 0x18, 0x60, 0x18, 0x00, 
	0xe0, 0x08, 0x18, 0x04, 0x00, 0x0c, 0x03, 0x10, 0x04, 0x00, 0x06, 0x01, 0x80, 0x60, 0x18, 0x00, 
	0x40, 0x30, 0x00, 0xc0, 0x18, 0x18, 0x06, 0x00, 0x04, 0x03, 0x03, 0x00, 0x63, 0x00, 0x60, 0x00, 
	0xc0, 0x30, 0x00, 0x60, 0x18, 0x60, 0x18, 0x01, 0xc0, 0x08, 0x18, 0x06, 0x00, 0x1c, 0x02, 0x10, 
	0x06, 0x00, 0x0e, 0x01, 0x80, 0x60, 0x10, 0x00, 0xc0, 0x30, 0x01, 0x80, 0x18, 0x18, 0x06, 0x00, 
	0x0c, 0x03, 0x03, 0x00, 0xc1, 0x80, 0x60, 0x00, 0xc0, 0x30, 0x00, 0x60, 0x18, 0x60, 0x18, 0x03, 
	0x80, 0x18, 0x18, 0x06, 0x00, 0x38, 0x06, 0x18, 0x06, 0x00, 0x1c, 0x03, 0x00, 0x60, 0x30, 0x00, 
	0xc0, 0x18, 0x03, 0x00, 0x18, 0x18, 0x06, 0x00, 0x0c, 0x03, 0x03, 0x01, 0x81, 0x80, 0x30, 0x00, 
	0xc0, 0x1c, 0x01, 0xc0, 0x10, 0x60, 0x0f, 0xff, 0x00, 0x18, 0x18, 0x03, 0xff, 0xf0, 0x06, 0x18, 
	0x03, 0xff, 0xf8, 0x03, 0x00, 0x40, 0x30, 0x00, 0x40, 0x1f, 0xfe, 0x00, 0x10, 0x18, 0x04, 0x00, 
	0x0c, 0x03, 0x02, 0x01, 0x80, 0xc0, 0x30, 0x00, 0x40, 0x0f, 0xff, 0x80, 0x30, 0x60, 0x07, 0xfc, 
	0x00, 0x18, 0x18, 0x01, 0xff, 0xc0, 0x0c, 0x18, 0x01, 0xff, 0xe0, 0x03, 0x00, 0xc0, 0x30, 0x00, 
	0x40, 0x0f, 0xf8, 0x00, 0x30, 0x10, 0x0c, 0x00, 0x0c, 0x02, 0x06, 0x01, 0x80, 0xc0, 0x18, 0x00, 
	0x60, 0x00, 0x00, 0x00, 0x30, 0x60, 0x00, 0x00, 0x00, 0x18, 0x08, 0x00, 0x00, 0x00, 0x0c, 0x18, 
	0x00, 0x00, 0x00, 0x06, 0x00, 0xc0, 0x30, 0x00, 0x60, 0x00, 0x00, 0x00, 0x30, 0x10, 0x0c, 0x00, 
	0x0c, 0x06, 0x06, 0x01, 0x80, 0x60, 0x0c, 0x00, 0x60, 0x00, 0x00, 0x00, 0x60, 0x30, 0x00, 0x00, 
	0x20, 0x10, 0x0c, 0x00, 0x00, 0x00, 0x18, 0x0c, 0x00, 0x00, 0x00, 0x0c, 0x00, 0xc0, 0x30, 0x00, 
	0x60, 0x00, 0x00, 0x20, 0x30, 0x30, 0x0c, 0x00, 0x08, 0x06, 0x06, 0x01, 0x80, 0x30, 0x0c, 0x00, 
	0x30, 0x00, 0x00, 0x00, 0x60, 0x30, 0x00, 0x00, 0x60, 0x30, 0x06, 0x00, 0x00, 0x00, 0x30, 0x0e, 
	0x00, 0x00, 0x00, 0x1c, 0x00, 0xc0, 0x20, 0x00, 0x30, 0x00, 0x00, 0x60, 0x30, 0x30, 0x0c, 0x00, 
	0x18, 0x06, 0x06, 0x01, 0x00, 0x30, 0x06, 0x00, 0x38, 0x00, 0x00, 0x00, 0xc0, 0x18, 0x00, 0x00, 
	0xe0, 0x30, 0x07, 0x00, 0x00, 0x00, 0x60, 0x07, 0x00, 0x00, 0x00, 0x38, 0x00, 0x80, 0x60, 0x00, 
	0x30, 0x00, 0x00, 0xe0, 0x30, 0x30, 0x08, 0x00, 0x18, 0x06, 0x06, 0x03, 0x00, 0x18, 0x06, 0x00, 
	0x1c, 0x00, 0x00, 0x03, 0x80, 0x0c, 0x00, 0x01, 0xe0, 0x30, 0x03, 0x80, 0x00, 0x00, 0xc0, 0x03, 
	0x80, 0x00, 0x00, 0x70, 0x01, 0x80, 0x60, 0x00, 0x18, 0x00, 0x03, 0xc0, 0x20, 0x30, 0x08, 0x00, 
	0x18, 0x06, 0x04, 0x03, 0x00, 0x18, 0x03, 0x00, 0x0f, 0x00, 0x00, 0x0f, 0x00, 0x0e, 0x00, 0x07, 
	0x60, 0x30, 0x01, 0xe0, 0x00, 0x03, 0x80, 0x01, 0xe0, 0x00, 0x01, 0xc0, 0x01, 0x80, 0x60, 0x00, 
	0x0e, 0x00, 0x07, 0xc0, 0x60, 0x20, 0x18, 0x00, 0x18, 0x04, 0x0c, 0x03, 0x00, 0x0c, 0x01, 0x80, 
	0x03, 0xe0, 0x00, 0xfc, 0x00, 0x03, 0xc0, 0x1e, 0x7f, 0xf0, 0x00, 0x7c, 0x00, 0x3f, 0x00, 0x00, 
	0x7c, 0x00, 0x1f, 0x80, 0x01, 0xff, 0xe0, 0x00, 0x07, 0xc0, 0x1e, 0xff, 0xe0, 0x7f, 0xf8, 0x00, 
	0x1f, 0xfc, 0x0f, 0xff, 0x00, 0x07, 0xff, 0x80, 0x00, 0xff, 0xff, 0xf0, 0x00, 0x00, 0xff, 0xf8, 
	0x7f, 0xe0, 0x00, 0x1f, 0xff, 0xf8, 0x00, 0x00, 0x1f, 0xff, 0xfc, 0x00, 0x01, 0xff, 0xc0, 0x00, 
	0x01, 0xff, 0xf8, 0xff, 0xe0, 0x7f, 0xf8, 0x00, 0x1f, 0xfc, 0x0f, 0xfe, 0x00, 0x07, 0xff, 0xc0, 
	0x00, 0x07, 0xfc, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 
	0x00, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// --- SUCOFUNK Logo Subline "beatmaker's sketchbook" / 320x11px
const unsigned char startup_logo_subline [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 
	0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 
	0x00, 0x00, 0x00, 0x00, 0x30, 0x03, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 
	0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x01, 0x80, 0x00, 0x30, 0x02, 0x00, 0x00, 
	0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 
	0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 
	0x00, 0x01, 0x80, 0x00, 0x20, 0x02, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x03, 0xf0, 0x3e, 0x0f, 0x83, 0xfe, 0x07, 0xe0, 0xcc, 0x1f, 
	0x03, 0xc0, 0x07, 0xc0, 0x00, 0x03, 0xe0, 0xcc, 0x1f, 0x83, 0xc1, 0xf0, 0x3f, 0x03, 0xf0, 0x3e, 
	0x07, 0xe0, 0xcc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0x82, 0x10, 
	0x42, 0x06, 0x06, 0x33, 0x04, 0x60, 0xd8, 0x31, 0x83, 0x00, 0x0c, 0x40, 0x00, 0x06, 0x20, 0xd8, 
	0x11, 0x81, 0x03, 0x18, 0x31, 0x06, 0x30, 0x63, 0x04, 0x20, 0xd8, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x21, 0x86, 0x30, 0x12, 0x04, 0x06, 0x22, 0x03, 0x60, 0xf0, 0x31, 
	0x82, 0x00, 0x0c, 0x00, 0x00, 0x06, 0x00, 0xf0, 0x31, 0x83, 0x03, 0x00, 0x21, 0x06, 0x30, 0x43, 
	0x0c, 0x20, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x21, 0x07, 0xf0, 
	0x7e, 0x04, 0x06, 0x62, 0x0f, 0xe0, 0xf0, 0x3f, 0x82, 0x00, 0x07, 0xc0, 0x00, 0x03, 0xc0, 0xf0, 
	0x3f, 0x83, 0x02, 0x00, 0x63, 0x04, 0x30, 0xc2, 0x08, 0x60, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x21, 0x04, 0x00, 0xc6, 0x04, 0x04, 0x62, 0x08, 0x40, 0x90, 0x20, 
	0x06, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x60, 0x90, 0x20, 0x03, 0x02, 0x10, 0x63, 0x04, 0x30, 0xc2, 
	0x08, 0x60, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x73, 0x06, 0x20, 
	0xce, 0x04, 0x04, 0x66, 0x0c, 0xc1, 0x98, 0x33, 0x06, 0x00, 0x08, 0xc0, 0x00, 0x0c, 0x61, 0x98, 
	0x33, 0x03, 0x03, 0x30, 0x43, 0x06, 0x60, 0xc6, 0x0c, 0xc0, 0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x03, 0xc0, 0x7c, 0x07, 0x04, 0x46, 0x0f, 0xc1, 0x88, 0x1e, 
	0x04, 0x00, 0x0f, 0x80, 0x00, 0x07, 0xc1, 0x88, 0x1e, 0x03, 0x81, 0xe0, 0x42, 0x07, 0xc0, 0x7c, 
	0x07, 0x81, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00
};


void setup() {
  //Serial.begin(9600);
  boolean ok = true;
  //strcpy(activeSongPath, songsBasePath); // init main path.. song directory will be concatenated, when available  

  MIDI.begin(MIDI_CHANNEL_OMNI);
  Serial.begin(57600);

  // Screeen Backlight regulator -> make screen dark
  pinMode(PIN_SCREEN_BL, OUTPUT);
  analogWrite(PIN_SCREEN_BL, 1); 

  // initialize screen
  tft.init(240, 320, SPI_MODE0);
  tft.setRotation(3);
  tft.fillScreen(screen.C_STARTUP_BG);

  screen.fadeBacklightIn(1);

  // fade logo in..
  for (int c=3; c<=370; c=c/3 + c) {   
    tft.drawBitmap(0, 86, startup_logo, 320, 54, screen.RGBtoColor(c > 255?255:c, c > 255?255:c, c > 255?255:c));    
    delay(20);
  };

  delay(200);
  // draw orange subline "beatmaker's sketchbook"
  tft.drawBitmap(0, 155, startup_logo_subline, 320, 11, screen.C_ORANGE);
  delay(750);

  currentAppContext = AppContext::STARTUP;
  startupContext.showMessage("system health check", false);

  keyboard.setBank(0);

  AudioMemoryUsageMaxReset();
  AudioMemory(50);

  // Enable the audio shield, select input and enable output
  audioResources.audioShield.enable();

  keyboard.setInput(Sucofunkey::INPUT_NONE);
  audioResources.muteInput();
  audioResources.muteResampling();
  audioResources.audioShield.volume(volumeValue);  //0.0-1.0 0.8=max without distortion

  // erase psram (sample memory)
  for (unsigned long i=0; i<sizeof(extmemArray)/4; i++) {
    extmemArray[i] = 0;
  }

  delay(300); // small delay for better readability on screen

  // enable SD card
  if (!(SD.begin(BUILTIN_SDCARD))) {    
      startupContext.showMessage("SD card not available", true);
      ok = false;
  } else {
      startupContext.showMessage("OK", false);
  }

  // start globalTickInterval Timer
  globalTickTimer.begin(globalTick, globalTickInterval);
  globalTickTimerRec.begin(globalTickRec, globalTickIntervalRec);

  fsio.readLibrarySamplesFromSD(librarySamples);

  delay(400); // small delay for better readability on screen
  
  if (ok) {
    startupContext.transitionToSelection();
  }
}


void sendEventToActiveContext(Sucofunkey::keyQueueStruct event) {
  switch(currentAppContext) {
    case AppContext::HOME: 
            homeContext.handleEvent(event);
            break;
    case AppContext::SAMPLER:
            samplerContext.handleEvent(event);
            break;
    case AppContext::SEQUENCER:
            sequencerContext.handleEvent(event);
            break;
    case AppContext::SYNTH:
            synthContext.handleEvent(event);
            break;
    case AppContext::LIVE:
            liveContext.handleEvent(event);
            break;
    case AppContext::SETTINGS:
              settingsContext.handleEvent(event);
            break;
    case AppContext::STARTUP:
            startupContext.handleEvent(event);
            break;
    case AppContext::RECORDER:
            recorderContext.handleEvent(event);
            break;
    case AppContext::SYSTEMCHECK:
            systemCheckContext.handleEvent(event);
            break;
    default:
            break;
  }
}

// --- START Timing ---

void globalTick() {
  ticked = true;
}

void globalTickRec() {
  tickedRec = true;
}


void sendTickToActiveContext() {
  switch(currentAppContext) {
    case  AppContext::HOME:
           globalTickIntervalNew = homeContext.receiveTimerTick();
          break;
    case  AppContext::SAMPLER:
           globalTickIntervalNew = samplerContext.receiveTimerTick();
          break;
    case  AppContext::SEQUENCER:
           globalTickIntervalNew = sequencerContext.receiveTimerTick();
          break;
    case  AppContext::STARTUP:
           globalTickIntervalNew = startupContext.receiveTimerTick();
          break;
    case  AppContext::SYSTEMCHECK:
           globalTickIntervalNew = systemCheckContext.receiveTimerTick();
          break;
    default:
          break;
  }    

//  globalTickIntervalNew = sequencerContext.receiveTimerTick();

  if (globalTickIntervalNew != globalTickInterval) {
    globalTickInterval = globalTickIntervalNew;
    globalTickTimer.update(globalTickInterval);
  }
}

// --- END Timing ---

int z = 0;
int zz = 0;


void loop() {
  // recording? -> has highest priority -> store record buffer to sd..
  if (recorderContext.currentState == recorderContext.RECORDER_RECORDING) recorderContext.continueRecording();
  z++;
  zz++;

  // handle encoder and keyboard events.. but divide reading PIN changes and handling the events into two loops to not disrupt recording
  // 1. Checks if a PIN changed (Key pressed, released or encoder state change) and adds it to the event queue
  if (z == 1) keyboard.hasKeyPressed();
  // 2. Reads the event queue and handles the occured event -> propagating to the right context
  if (z == 2) { 
    handleKeyboardEventQueue();
    z = 0;  
  }
  // On every 200th loop, check if the volume potentiometer was changed and adjust the volume.
  if (zz == 20) {    
    volumeTempValue = 0.8-((analogRead(PIN_VOLUME)/1023.0)*0.8);
    
    if (abs(volumeValue-volumeTempValue) > 0.05) {
      volumeValue = volumeTempValue;
//      Serial.print("Volume::");
//      Serial.println(volumeValue);
      audioResources.audioShield.volume(volumeValue);
    }    
    
    zz = 0;
  }

  // timer handling while recording to update the peak meter of the input
  if (tickedRec) {
    tickedRec = false;
    globalTickIntervalRecNew = recorderContext.receiveTimerTick();
    
    if (globalTickIntervalRecNew != globalTickIntervalRec) {
      globalTickIntervalRec = globalTickIntervalRecNew;
      globalTickTimerRec.update(globalTickIntervalRec);
    }  
  }

  // handle timer and delegate it to the current active context (e.g. sampler, sequencer, ...)
  if (ticked) {
    ticked=false;
    sendTickToActiveContext();
  }

  // update fader reading queue
  keyboard.updateContinuousFaderValue();

  if (MIDI.read()) { 
    // route midi messages for MIDI_channel_Synth and system messages to the synth
    if ((MIDI.getChannel() == MIDI_channel_Synth || MIDI.getChannel() == 0) && currentAppContext == SYNTH) {
      Serial.println("Synth context midi");
      synthContext.receiveMidiData(MIDI.getType(), MIDI.getData1(), MIDI.getData2());
    }

    if (MIDI.getChannel() == MIDI_channel_Live) {
/*      Serial.print("MIDI::");
      Serial.print(MIDI.getChannel());
      Serial.print("::");
      Serial.print(MIDI.getType());
      Serial.print("::");
      Serial.print(MIDI.getData1());
      Serial.print("::");
      Serial.println(MIDI.getData2());
*/
      //keyboard.setLEDState(Sucofunkey::LED_PLAY, true);
      liveContext.receiveMidiData(MIDI.getType(), MIDI.getData1(), MIDI.getData2());
    }
  }
}


void changeContext(AppContext context) {    
    screen.fadeBacklightOut(1);
    
    homeContext.setActive(false);
    samplerContext.setActive(false);

    if (currentAppContext == SEQUENCER && sequencerContext.isPlaying() && context == SAMPLER) {
      // warning?
      // or fix it with two seperated timers.. but maybe we need them later for something else..
    } 
    else {
      sequencerContext.setActive(false);
    }
        
    synthContext.setActive(false);
    liveContext.setActive(false);
    settingsContext.setActive(false);
    recorderContext.setActive(false);

    // save to context we are currently in, to switch back to it, if e.g. RECORDER_CANCEL happens
    lastAppContext = currentAppContext;

    switch (context) {
      case  AppContext::HOME: 
                  homeContext.setActive(true);
                  currentAppContext = HOME;
                  break;
      case  AppContext::SAMPLER: 
                  if (!recorderContext.isRecording() && !sequencerContext.isPlaying()) {
                    samplerContext.setActive(true);
                    currentAppContext = SAMPLER;
                  }                  
                  break;
      case  AppContext::SEQUENCER: 
                  sequencerContext.setActive(true);
                  currentAppContext = SEQUENCER;
                  break;
      case  AppContext::SYNTH: 
                  synthContext.setActive(true);
                  currentAppContext = SYNTH;
                  break;
      case  AppContext::LIVE: 
                  liveContext.setActive(true);
                  currentAppContext = LIVE;
                  break;
      case  AppContext::SETTINGS: 
                  settingsContext.setActive(true);
                  currentAppContext = SETTINGS;
                  break;                  
      case  AppContext::RECORDER: 
                  recorderContext.setActive(true);
                  currentAppContext = RECORDER;
                  break;                  
      case AppContext::SYSTEMCHECK:
                  systemCheckContext.setActive(true);
                  currentAppContext = SYSTEMCHECK;                                    
      default: 
                  break;                  
    }    

    if (!screen.isBacklightOn()) screen.fadeBacklightIn(10);
}

void handleKeyboardEventQueue() {
  bool preCheck = false; // did we already process a key press in a "precondition", e.g. go to main menu?

  while(keyboard.hasEvents()) {
    Sucofunkey::keyQueueStruct event = keyboard.getNextEvent();
/*
    Serial.print(event.index);
    Serial.print("::");
    Serial.print(event.pressed);
    Serial.print("::");
    Serial.println(event.type);
*/

/*
    Serial.print("MaxAudioMemoryUsed:: ");
    Serial.println(AudioMemoryUsageMax());
*/

    if (event.type == Sucofunkey::EVENT_APPLICATION) {
      switch(event.index) {
        case Sucofunkey::SONGSELECTED:
          // generate new _activeSongPath after selecting or creating a song
          strcpy(activeSongPath, songsBasePath);
          strcat(activeSongPath, activeSongName);
          sfsio.setSongPath(activeSongPath);
          screen.loadingScreen(0.0);
          sfsio.writeAllSamplesToWaveformBuffer();

          // load sequencer data from SD card
          //sequencerContext.loadFromSD();

          changeContext(AppContext::HOME);          
          break;

        case Sucofunkey::RECORDED:
          changeContext(AppContext::SAMPLER);
          break;

        case Sucofunkey::RECORDER_CANCEL:
          changeContext(lastAppContext);
          break;

        case Sucofunkey::CHECKREQUEST:
          changeContext(AppContext::SYSTEMCHECK);
        default:
          break;
      }      
    }

    // Encoder pushed -> with MENU in every context: change context .. in home screen the same without FN OR Main menu OR Settings
    if (currentAppContext!=STARTUP && currentAppContext!=SYSTEMCHECK && event.pressed && (event.type == Sucofunkey::KEY_MENU_OPERATION || (currentAppContext == AppContext::HOME && event.type == Sucofunkey::KEY_OPERATION) || event.index == Sucofunkey::FN_FUNCTION || event.index == Sucofunkey::MENU_MENU)) {
      switch (event.index) {
        case Sucofunkey::ENCODER_1_PUSH:  
        case Sucofunkey::MENU_ENCODER_1_PUSH:  
              changeContext(SAMPLER);
              preCheck = true;
              break;
        case Sucofunkey::ENCODER_2_PUSH:
        case Sucofunkey::MENU_ENCODER_2_PUSH:          
              changeContext(SEQUENCER);
              preCheck = true;
              break;             
        case Sucofunkey::ENCODER_3_PUSH:  
        case Sucofunkey::MENU_ENCODER_3_PUSH:        
              changeContext(SYNTH);
              preCheck = true;
              break; 
        case Sucofunkey::ENCODER_4_PUSH:
        case Sucofunkey::MENU_ENCODER_4_PUSH:          
              changeContext(LIVE);
              preCheck = true;
              break;
        case Sucofunkey::FN_FUNCTION:  
              changeContext(SETTINGS);
              preCheck = true;
              break;
        case Sucofunkey::MENU_MENU:  
              changeContext(HOME);
              preCheck = true;
              break;
      }
    }

    if (!preCheck && currentAppContext != STARTUP && currentAppContext != SYSTEMCHECK && event.type == Sucofunkey::KEY_OPERATION) {    
      
      // Intention to start recording..
      if (event.index == Sucofunkey::RECORD && event.pressed) { 
        if (currentAppContext != RECORDER && !recorderContext.isRecording()) {                    
          changeContext(RECORDER);
          preCheck = true;
        }
        if (currentAppContext != RECORDER && recorderContext.isRecording()) {          
          recorderContext.stopRecording();
          preCheck = true;
        }
      } 
    }

    if (!preCheck) {
      sendEventToActiveContext(event);
    }   
  }
}